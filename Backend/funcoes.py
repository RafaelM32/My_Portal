import urllib.request
from datetime import datetime
from database import*

img_ = '"https://i.ytimg.com/vi/PS3ueqzzles/hqdefault.jpg?sqp=-oaymwEiCKgBEF5IWvKriqkDFQgBFQAAAAAYASUAAMhCPQCAokN4AQ==\\u0026rs=AOn4CLBYe6HW9zvEU7lzyiOPJ2XyXjskGQ","width":168,"height":94},{"url":"https://i.ytimg.com/vi/PS3ueqzzles/hqdefault.jpg?sqp=-oaymwEiCMQBEG5IWvKriqkDFQgBFQAAAAAYASUAAMhCPQCAokN4AQ==\\u0026rs=AOn4CLD8zJA6ZKAXHRPmhwqq-o_W0Wi37g","width":196,"height":110},{"url":"https://i.ytimg.com/vi/PS3ueqzzles/hqdefault.jpg?sqp=-oaymwEjCPYBEIoBSFryq4qpAxUIARUAAAAAGAElAADIQj0AgKJDeAE=\\u0026rs=AOn4CLC97j2kKkLklY1XBlZEpQoxrXEpfQ","width":246,"height":138},{"url":"https://i.ytimg.com/vi/PS3ueqzzles/hqdefault.jpg?sqp=-oaymwEjCNACELwBSFryq4qpAxUIARUAAAAAGAElAADIQj0AgKJDeAE=\\u0026rs=AOn4CLCVHcvdRTLGw5SfcM2meC44N6WgWA","width":336,"height":188}]},"title":{"runs":[{"text":"MAIS ATRAPALHAM DO QUE AJUDAM"}],"accessibility":{"accessibilityData":{"label":"MAIS ATRAPALHAM DO QUE AJUDAM Mamaefalei 136.153 visualiza\xc3\xa7\xc3\xb5es h\xc3\xa1 1 m\xc3\xaas 27 minutos"}}},"descriptionSnippet":{"runs":[{"text":"Seja membro deste canal e ganhe benef\xc3\xadcios:\\nhttps://www.youtube.com/channel/UCkSjy-IOEq-eMtarZl2uH1Q/join\\n\\nInscreva-se no canal:\\nhttps://www.youtube.com/mamaefalei?sub_confirmation=1\\n\\nMe siga..."}]},"publishedTimeText":{"simpleText":"h\xc3\xa1 1 m\xc3\xaas"},"lengthText":{"accessibility":{"accessibilityData":{"label":"27 minutos e 39 segundos"}},"simpleText":"27:39"},"viewCountText":{"simpleText":"136.153 visualiza\xc3\xa7\xc3\xb5es"},"navigationEndpoint":{"clickTrackingParams":"CDUQ3DAiEwjZ-5zjrOCGAxVDu5UCHXPMBq5aGFVDa1NqeS1JT0VxLWVNdGFyWmwydUgxUZoBAxDyOA==","commandMetadata":{"webCommandMetadata":{"url":"/watch?v=PS3ueqzzles","webPageType":"WEB_PAGE_TYPE_WATCH","rootVe":3832}},"watchEndpoint":{"videoId":"PS3ueqzzles","watchEndpointSupportedOnesieConfig":{"html5PlaybackOnesieConfig":{"commonConfig":{"url":"https://rr1---sn-faxoxucg-bpbe.googlevideo.com/initplayback?source=youtube\\u0026oeis=1\\u0026c=WEB\\u0026oad=3200\\u0026ovd=3200\\u0026oaad=11000\\u0026oavd=11000\\u0026ocs=700\\u0026oewis=1\\u0026oputc=1\\u0026ofpcc=1\\u0026msp=1\\u0026odepv=1\\u0026id=3d2dee7aacf395eb\\u0026ip=138.99.134.58\\u0026initcwndbps=457500\\u0026mt=1718548375\\u0026oweuc=\\u0026pxtags=Cg4KAnR4Egg1MTE4MTI5Ng\\u0026rxtags=Cg4KAnR4Egg1MTE4MTI5Ng%2CCg4KAnR4Egg1MTE4MTI5Nw%2CCg4KAnR4Egg1MTE4MTI5OA"}}}}},"ownerBadges":[{"metadataBadgeRenderer":{"icon":{"iconType":"CHECK_CIRCLE_THICK"},"style":"BADGE_STYLE_TYPE_VERIFIED","tooltip":"Verificado","trackingParams":"CDUQ3DAiEwjZ-5zjrOCGAxVDu5UCHXPMBq4=","accessibilityData":{"label":"Verificado"}}}],"trackingParams":"CDUQ3DAiEwjZ-5zjrOCGAxVDu5UCHXPMBq5A66vO56rP-5Y9","showActionMenu":false,"shortViewCountText":{"accessibility":{"accessibilityData":{"label":"136 mil visualiza\xc3\xa7\xc3\xb5es"}},"simpleText":"136\xc2\xa0mil visualiza\xc3\xa7\xc3\xb5es"},"menu":{"menuRenderer":{"items":[{"menuServiceItemRenderer":{"text":{"runs":[{"text":"Adicionar \xc3\xa0 fila"}]},"icon":{"iconType":"ADD_TO_QUEUE_TAIL"},"serviceEndpoint":{"clickTrackingParams":"CDkQ_pgEGAYiEwjZ-5zjrOCGAxVDu5UCHXPMBq4=","commandMetadata":{"webCommandMetadata":{"sendPost":true}},"signalServiceEndpoint":{"signal":"CLIENT_SIGNAL","actions":[{"clickTrackingParams":"CDkQ_pgEGAYiEwjZ-5zjrOCGAxVDu5UCHXPMBq4=","addToPlaylistCommand":{"openMiniplayer":true,"videoId":"PS3ueqzzles","listType":"PLAYLIST_EDIT_LIST_TYPE_QUEUE","onCreateListCommand":{"clickTrackingParams":"CDkQ_pgEGAYiEwjZ-5zjrOCGAxVDu5UCHXPMBq4=","commandMetadata":{"webCommandMetadata":{"sendPost":true,"apiUrl":"/youtubei/v1/playlist/create"}},"createPlaylistServiceEndpoint":{"videoIds":["PS3ueqzzles"],"params":"CAQ%3D"}},"videoIds":["PS3ueqzzles"]}}]}},"trackingParams":"CDkQ_pgEGAYiEwjZ-5zjrOCGAxVDu5UCHXPMBq4="}},{"menuServiceItemRenderer":{"text":{"runs":[{"text":"Compartilhar"}]},"icon":{"iconType":"SHARE"},"serviceEndpoint":{"clickTrackingParams":"CDUQ3DAiEwjZ-5zjrOCGAxVDu5UCHXPMBq4=","commandMetadata":{"webCommandMetadata":{"sendPost":true,"apiUrl":"/youtubei/v1/share/get_share_panel"}},"shareEntityServiceEndpoint":{"serializedShareEntity":"CgtQUzN1ZXF6emxlcw%3D%3D","commands":[{"clickTrackingParams":"CDUQ3DAiEwjZ-5zjrOCGAxVDu5UCHXPMBq4=","openPopupAction":{"popup":{"unifiedSharePanelRenderer":{"trackingParams":"CDgQjmIiEwjZ-5zjrOCGAxVDu5UCHXPMBq4=","showLoadingSpinner":true}},"popupType":"DIALOG","beReused":true}}]}},"trackingParams":"CDUQ3DAiEwjZ-5zjrOCGAxVDu5UCHXPMBq4="}}],"trackingParams":"CDUQ3DAiEwjZ-5zjrOCGAxVDu5UCHXPMBq4=","accessibility":{"accessibilityData":{"label":"Menu de a\xc3\xa7\xc3\xb5es"}}}},"thumbnailOverlays":[{"thumbnailOverlayTimeStatusRenderer":{"text":{"accessibility":{"accessibilityData":{"label":"27 minutos e 39 segundos"}},"simpleText":"27:39"},"style":"DEFAULT"}},{"thumbnailOverlayToggleButtonRenderer":{"isToggled":false,"untoggledIcon":{"iconType":"WATCH_LATER"},"toggledIcon":{"iconType":"CHECK"},"untoggledTooltip":"Assistir mais tarde","toggledTooltip":"Adicionado","untoggledServiceEndpoint":{"clickTrackingParams":"CDcQ-ecDGAIiEwjZ-5zjrOCGAxVDu5UCHXPMBq4=","commandMetadata":{"webCommandMetadata":{"sendPost":true,"apiUrl":"/youtubei/v1/browse/edit_playlist"}},"playlistEditEndpoint":{"playlistId":"WL","actions":[{"addedVideoId":"PS3ueqzzles","action":"ACTION_ADD_VIDEO"}]}},"toggledServiceEndpoint":{"clickTrackingParams":"CDcQ-ecDGAIiEwjZ-5zjrOCGAxVDu5UCHXPMBq4=","commandMetadata":{"webCommandMetadata":{"sendPost":true,"apiUrl":"/youtubei/v1/browse/edit_playlist"}},"playlistEditEndpoint":{"playlistId":"WL","actions":[{"action":"ACTION_REMOVE_VIDEO_BY_VIDEO_ID","removedVideoId":"PS3ueqzzles"}]}},"untoggledAccessibility":{"accessibilityData":{"label":"Assistir mais tarde"}},"toggledAccessibility":{"accessibilityData":{"label":"Adicionado"}},"trackingParams":"CDcQ-ecDGAIiEwjZ-5zjrOCGAxVDu5UCHXPMBq4="}},{"thumbnailOverlayToggleButtonRenderer":{"untoggledIcon":{"iconType":"ADD_TO_QUEUE_TAIL"},"toggledIcon":{"iconType":"PLAYLIST_ADD_CHECK"},"untoggledTooltip":"Adicionar \xc3\xa0 fila","toggledTooltip":"Adicionado","untoggledServiceEndpoint":{"clickTrackingParams":"CDYQx-wEGAMiEwjZ-5zjrOCGAxVDu5UCHXPMBq4=","commandMetadata":{"webCommandMetadata":{"sendPost":true}},"signalServiceEndpoint":{"signal":"CLIENT_SIGNAL","actions":[{"clickTrackingParams":"CDYQx-wEGAMiEwjZ-5zjrOCGAxVDu5UCHXPMBq4=","addToPlaylistCommand":{"openMiniplayer":true,"videoId":"PS3ueqzzles","listType":"PLAYLIST_EDIT_LIST_TYPE_QUEUE","onCreateListCommand":{"clickTrackingParams":"CDYQx-wEGAMiEwjZ-5zjrOCGAxVDu5UCHXPMBq4=","commandMetadata":{"webCommandMetadata":{"sendPost":true,"apiUrl":"/youtubei/v1/playlist/create"}},"createPlaylistServiceEndpoint":{"videoIds":["PS3ueqzzles"],"params":"CAQ%3D"}},"videoIds":["PS3ueqzzles"]}}]}},"untoggledAccessibility":{"accessibilityData":{"label":"Adicionar \xc3\xa0 fila"}},"toggledAccessibility":{"accessibilityData":{"label":"Adicionado"}},"trackingParams":"CDYQx-wEGAMiEwjZ-5zjrOCGAxVDu5UCHXPMBq4="}},{"thumbnailOverlayNowPlayingRenderer":{"text":{"runs":[{"text":"Tocando agora"}]}}}]}},"trackingParams":"CDQQmY0FGBwiEwjZ-5zjrOCGAxVDu5UCHXPMBq4="}},{"richItemRenderer":{"content":{"videoRenderer":{"videoId":"HkGvFCSMp_c","thumbnail":'

def html_from_url(url):
   return str(urllib.request.urlopen(url).read())


#This function extracts the url from the videos in the page
def list_of_videos_and_images(url):
    videos_list = []
    tumb_list = []
    page = html_from_url(url)
    videos = page.split("watch?v=")[1:]
    images = page.split('{"thumbnails":[{"url":')[1:-2]
    for video in videos:
        if len(video) > 6000:
            videos_list.append(video[:11])
    for image in images:
        tumb_link = take_tumb(image)
        if '://i.ytimg.com/vi' in tumb_link:
            tumb_list.append(tumb_link)
    return {'videos_list': videos_list, 'tumb_list':  tumb_list}


#This function cheks if has bem passed more than x minutes
def is_more_the_x_minutes(x):
    now = datetime.now()
    last_load = load_video_list()['time']
    total_minutes = ((now - last_load).total_seconds())/60
    if total_minutes >= x:
        return True
    else:
        return False




#This function cheks is a chennel alrely is in the chennels list
def channel_is_saved(channel):
    return channel_is_saved_in_database(channel)


#This function saves a new chennel in the list
def save_channel(channel):
    if not channel_is_saved(channel):
        save_channel_in_database(channel)
        return f'{channel.split('/')[3]} foi adicionado com sucesso!'
    else:
        return f'{channel.split('/')[3]} já consta na lista de canais!'


#This deleletes a channel in the channel_list
def delete_channel(channel):
    if channel_is_saved(channel):
        delete_channel_in_database(channel)
        return f'{channel.split('/')[3]} foi removido com sucesso!'
    else:
        return f'{channel.split('/')[3]} não está na lista!'


#This function makes de reload of the videos in channels
def update_videos_list():
    for canal in load_channels_list_in_database():
        lista_de_videos_e_imagens_no_canal = list_of_videos_and_images(canal)
        update_channel_videos_list(canal,lista_de_videos_e_imagens_no_canal['videos_list'])
        update_channel_tumb_list(canal,lista_de_videos_e_imagens_no_canal['tumb_list'])
    make_videos_list()


#This function is to send the videos to Frontend
def send_videos_list():
    return load_video_list()


def take_tumb(img:str):
    return img.split('"width')[0][1:-2]

